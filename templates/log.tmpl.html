<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Pruu a HTTP dump tool and request simulator">
    <title>Pruu</title>
    
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css" integrity="sha384-" crossorigin="anonymous">
    
    
    
        <!--[if lte IE 8]>
            <link rel="stylesheet" href="css/layouts/email-old-ie.css">
        <![endif]-->
        <!--[if gt IE 8]><!-->
            <link rel="stylesheet" href="/assets/css/layouts/log.css">
        <!--<![endif]-->
        <style>
        
        #clear-button{
            width: 100%;
            background-color: #095da5;
            color: white;
            border: none;
            text-align: center;
        }
        
        .logDisplay {            
            color:white;
            margin:0px;
        }

        </style>
</head>
<body class="bckColor">
<div class="topo">
    <img src="/assets/img/common/4866-200.png" width="40px"/>
    
</div>
<div>
    <button id="clear-button">Delete logs</button>
    <div id="logs" class="logDisplay">
    
    {{range .logs}}    
        <div data-id="{{.ID}}" class="log-line" data-level="{{.Level}}">
            <span class="text date">{{.CreatedAt.Format "2006-01-02T15:04:05"}}</span>&nbsp;
            <span class="text level-{{.Level}}">{{.Level}}</span>&nbsp;
            {{ range $key, $value := .Tags }}
                <span class="text tag">{{ $key }}={{ $value }}</span>
            {{ end }}
            <span class="text message">{{.Value}}</span>
        </div>        
    {{end}}
    </div>
</div>
</div>

<script>
    document.getElementById("clear-button").onclick = clear;
    var logView = document.getElementById("logs")
    function clear(){        
        fetch(window.location.href, {method: 'DELETE'}).then((_ => location.reload()));
    }
    function createElementFromHTML(htmlString) {
        var div = document.createElement('div');        
        div.innerHTML = htmlString.trim();

        // Change this to div.childNodes to support multiple top-level nodes
        return div.children;
    }
    var emptyCount = 0
    var tickTimeout = null
    var tickStep = 300
    const baseTimeout = 1000
    function schedule(callback){
        clearTimeout(tickTimeout)
        tickTimeout = setTimeout(callback,baseTimeout + emptyCount)
    }

    function loadData(){
        var id = 0;
        if(logView.children.length > 0){
            var last = logView.children[logView.children.length-1]
            id = parseInt(last.getAttribute("data-id")) + 1;
        }        
        const url = window.location.protocol+"//"+window.location.host+"/json"+window.location.pathname+"?offset="+id
        try{
            var fetchProm = fetch(url, {method: 'GET'})
            fetchProm.catch(x => {
                location.reload()
            })
            fetchProm.then((x => {        
            x.json().then(list =>{
                if(list.length === 0){
                    emptyCount += tickStep
                    if(emptyCount > 15000){
                        emptyCount = 15000;//max wait
                    }
                    setTimeout(()=>{
                        console.log(`next tick on ${(baseTimeout+emptyCount)/1000}s`)
                        schedule(loadData)
                    },1)
                    
                    return;
                }
                emptyCount = 0;
                var tmpl = list.map(l => `
                <div data-id="${l.id}" class="log-line" data-level="${l.level}">
                    <span class="text date">${l.created_at}</span>&nbsp;
                    <span class="text level-${l.level}">${l.level}</span>&nbsp;
                    ${Object.keys(l.tags).map(k => `<span class="text tag">${k}=[${l.tags[k].join(" ")}]</span>`)}                    
                    <span class="text message">${l.value}</span>
                </div>  
                `)
                var el = createElementFromHTML(tmpl.join(" "))
                for(var i=0; i<el.length;i++){
                    logView.appendChild(el[i])
                }                
                
                setTimeout(()=>{
                    schedule(loadData)
                },1)
            })
        }))
        }catch(e){
            location.reload()
        }
        
    }


    schedule(loadData)

    
</script>



</body>
</html>
